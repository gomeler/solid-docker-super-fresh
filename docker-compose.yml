version: "3"
services:
    mariadb:
        image: mariadb
        hostname: mariadb
        environment:
          - MYSQL_ROOT_PASSWORD=password
        ports:
          - 3306:3306
        networks:
            cindernet:
                ipv4_address: 172.49.49.2
        volumes:
            #- ./data/db-data:/var/lib/mysql
            #- ./data/db-logs:/var/log
            - ./mariadb/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d

    rabbitmq:
        image: rabbitmq
        ports:
          - 5672:5672
        hostname: rabbitmq
        networks:
            cindernet:
                ipv4_address: 172.49.49.3

    keystone:
        image: test:keystone
        depends_on:
          - mariadb
        ports:
          - 5000:5000
          - 35357:35357
        hostname: keystone
        networks:
            cindernet:
                ipv4_address: 172.49.49.4
        extra_hosts:
            - "mariadb:172.49.49.2"
            - "rabbitmq:172.49.49.3"
            - "cinder-api:172.49.49.5"
        volumes:
          - ./keystone:/etc/keystone_cp
          - ./data/keystone-logs:/var/log/keystone/
        entrypoint: /etc/keystone_cp/keystone.sh 
        #entrypoint: /etc/keystone_cp/idle.sh
        container_name: keystone


    cinder-api:
        image: cinder
        hostname: cinder-api
        volumes:
            - ./cinder/etc/:/etc/cinder
            - ./cinder/init-script/:/init-script/
        networks:
            cindernet:
                ipv4_address: 172.49.49.5
        ports:
            - 8776:8776
        depends_on:
          - mariadb
        extra_hosts:
            - "mariadb:172.49.49.2"
            - "rabbitmq:172.49.49.3"
            - "keystone:172.49.49.4"
        environment:
            - INIT_DB=true
#        command: sh /init-script/cinder-api.sh
        # Wait for the database to come online, so db sync doesn't fail repeatedly.
        command: ["/etc/cinder/wait-for-it.sh", "mariadb:3306", "-t", "60", "--", "/init-script/cinder-api.sh"]

    cinder-scheduler:
        image: cinder
        hostname: cinder-scheduler
        volumes:
            - ./cinder/etc/:/etc/cinder
        depends_on:
          - mariadb
          - rabbitmq
          - cinder-api
        extra_hosts:
            - "mariadb:172.49.49.2"
            - "rabbitmq:172.49.49.3"
            - "keystone:172.49.49.4"
            - "cinder-api:172.49.49.5"
        network_mode: "host"
        restart: on-failure
        command: cinder-scheduler
        command: ["/etc/cinder/wait-for-it.sh", "cinder-api:8776", "-t", "60", "--", "cinder-scheduler"]


    cinder-volume:
        image: cinder-lvm
        hostname: cinder-lvm
        privileged: true
        volumes:
            - ./cinder/etc/:/etc/cinder
            - /dev/:/dev/
            - /run/:/run/:shared
            - /etc/localtime:/etc/localtime:ro
            - /lib/modules:/lib/modules:ro
            - ./cinder/init-script/:/init-script/
        depends_on:
          - cinder-scheduler
        ports:
            - 3260:3260
        extra_hosts:
            - "mariadb:172.49.49.2"
            - "rabbitmq:172.49.49.3"
            - "keystone:172.49.49.4"
            - "cinder-api:172.49.49.5"
        network_mode: "host"
        restart: on-failure
        #command: bash -c "sleep 5 && /usr/sbin/tgtd && cinder-volume -d"
        command: ["/etc/cinder/wait-for-it.sh", "cinder-api:8776", "-t", "60", "--", "/init-script/cinder-volume.sh"]

    client:
        image: test:client
        hostname: client
        depends_on:
            - keystone
        networks:
            cindernet:
                ipv4_address: 172.49.49.10
        extra_hosts:
            - "rabbitmq:172.49.49.2"
            - "mariadb:172.49.49.3"
            - "keystone:172.49.49.4"
            - "cinder-api:172.49.49.5"
        volumes:
          - ./client:/etc/client
        container_name: client
        restart: always
        #entrypoint: /etc/client/idle.sh
        command: ["./etc/client/wait-for-it.sh", "keystone:5000", "-t", "60", "--", "./etc/client/idle.sh"]


networks:
    cindernet:
        driver: bridge
        ipam:
            driver: default
            config:
            -
              subnet: 172.49.49.0/24
